# 规则完善代理

## 任务概述

通过对比人工修复后的转换文件和源文件，自动总结转换规则并完善到规则库中。

**核心原则**：
- 智能分析差异，提取转换规则
- 与用户确认后，智能合并到现有规则
- 保持规则格式一致

## 重要说明

- **文件夹路径**：`rule_refinement`（位于项目根目录）
- **规则文件位置**：`prompt/rules/` 目录下的模块化规则文件
- **前提条件**：用户已将 2 个文件放入 `rule_refinement` 文件夹

---

## 开始执行

### 第一步：检查文件夹并识别文件类型

1. 列出 `rule_refinement` 文件夹中的所有文件
2. 根据文件扩展名识别文件类型：

**组合 1：Designer + XAML**
- `.Designer.cs` + `.xaml`
- 这是从 WinForms Designer 转换到 WPF XAML 的规则

**组合 2：CS + CS**
- 两个 `.cs` 文件
- 这是从 WinForms 后台代码转换到 WPF 后台代码的规则

**错误处理**：
- 如果 `rule_refinement` 文件夹不存在，提示用户："错误：rule_refinement 文件夹不存在，请创建该文件夹并放入需要分析的文件"
- 如果文件夹中没有文件，提示用户："错误：rule_refinement 文件夹为空，请放入 2 个文件（Designer+XAML 或 CS+CS）"
- 如果文件数量不是 2 个，提示用户："错误：rule_refinement 文件夹中的文件数量不正确（当前：{数量} 个），请只放入 2 个文件"
- 如果文件组合不正确，提示用户："错误：文件组合不正确，请确保是以下组合之一：\n  1. .Designer.cs + .xaml\n  2. .cs + .cs"
- 如果遇到以上任何错误，**停止执行并等待用户修正**

### 第二步：读取文件内容

1. 读取源文件内容（第一个文件）
2. 读取目标文件内容（第二个文件）
3. 读取规则索引文件：`prompt/rules/rule_index.md`
4. 根据文件类型，按照 `rule_index.md` 中的规则文件选择指南，读取对应的模块化规则文件

### 第三步：分析差异并提取规则

根据文件类型进行不同的分析：

#### 如果是 Designer + XAML：

1. **分析控件映射**：
   - WinForms 控件 → WPF 控件的映射关系
   - 控件属性的变化（如 Name → x:Name）
   - 命名空间的变化

2. **分析布局变化**：
   - 布局容器的变化（如 TableLayoutPanel → LayoutControl）
   - 布局属性的变化

3. **分析事件变化**：
   - 事件名称的变化
   - 事件处理方式的变化

4. **分析其他变化**：
   - 属性值的转换
   - 新增或删除的元素

#### 如果是 CS + CS：

1. **分析属性变化**：
   - WinForms 属性 → WPF 属性的映射
   - 属性值类型的变化（如 bool → Visibility）

2. **分析方法变化**：
   - 方法调用的变化
   - 参数类型的变化

3. **分析事件变化**：
   - 事件订阅方式的变化
   - 事件参数类型的变化

4. **分析控件访问方式**：
   - 控件属性访问的变化
   - 控件方法调用的变化

5. **分析命名空间变化**：
   - using 语句的变化
   - 类型全名的变化

**向用户展示**：
- 发现的所有差异点
- 提取的转换规则（逐条列出）
- 每条规则的示例代码

**向用户确认**：
- 提取的规则是否正确？
- 是否需要添加、修改或删除某些规则？

### 第四步：生成规则文本

根据用户确认的规则，生成符合现有规则格式的文本。

**规则格式要求**：

对于 Designer + XAML：
- 使用 Markdown 格式
- 按类别组织（布局、控件、事件、属性等）
- 提供清晰的示例代码
- 使用代码块展示转换前后对比

对于 CS + CS：
- 使用 Markdown 格式
- 按类别组织（通用属性、表格、定时器、特殊场景等）
- 提供清晰的示例代码
- 使用代码块展示转换前后对比

### 第五步：智能合并到现有规则

1. 读取现有规则文件的完整内容
2. 分析新生成的规则与现有规则的关系：
   - 是否有重复规则？跳过
   - 是否有冲突规则？向用户确认如何处理
   - 是否有可以合并的规则？智能合并
   - 如果是新规则，追加到相应章节

**向用户展示**：
- 合并后的完整规则文件内容
- 标注新增/修改的部分

**向用户确认**：
- 合并结果是否满意？
- 是否确认写入规则文件？

### 第六步：写入规则文件

根据 `prompt/rules/rule_index.md` 中的规则文件选择指南，写入对应的模块化文件

### 第七步：清理文件夹

完成写入后，询问用户是否清空 `rule_refinement` 文件夹。

---

## 注意事项

- **规则格式必须与现有规则保持一致**
- **智能合并时要仔细检查冲突**
- **提供清晰的示例代码**
- **使用中文注释和说明**
- **规则文件选择遵循 rule_index.md 的指引**