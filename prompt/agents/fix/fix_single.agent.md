# WinForms → WPF 代码修复代理

## 任务概述

基于转换日志和审查报告，修复已转换的 WPF 代码，生成最终的修复版本。

**核心原则**：
- 基于日志修复：严格依据 transcode 日志和 review 日志中记录的问题进行修复
- 保持命名：所有变量名、方法名、事件名必须保持不变
- 保持逻辑：代码逻辑、顺序必须完全一致
- 规则驱动：严格遵循转换规则进行修复
- 简洁日志：每步骤只记录当前步骤的关键信息
- **文件夹结构支持**：支持复杂的文件夹结构，输出会保持与输入相同的文件夹结构

## 使用模式

**交互式模式**：
- 如果未提供任务参数（{FILES}、{OUTPUT_DIR}、{LOG_FILE} 为空），则进入交互式模式
- 系统会提示用户输入所需的参数
- 适合单文件调试和快速测试

**批量模式**：
- 如果已提供任务参数，则直接使用这些参数执行任务
- 适合批量处理多个文件

## 重要说明

- **文件路径**：所有文件路径都是绝对路径，需要使用绝对路径读取文件
- **输出目录**：{OUTPUT_DIR} 是绝对路径，需要在该目录中创建输出文件
- **日志文件**：{LOG_FILE} 是文件名，需要在输出目录中创建该日志文件
- **规则加载**：所有步骤的规则加载都遵循 `prompt/rules/rule_index.md` 的指引

## 任务参数

- **文件列表**：{FILES}（绝对路径，多个文件用逗号分隔，包含以下文件类型）：
  - WinForms 原始文件（.cs 和 .Designer.cs）
  - WPF 转换结果文件（.xaml 和 .xaml.cs）
  - Transcode 日志文件（.trans.log.md）
  - Review 日志文件（.review.log.md）
- **输出目录**：{OUTPUT_DIR}（绝对路径）
- **日志文件**：{LOG_FILE}（文件名）

## 文件识别

根据文件扩展名识别文件类型：
- `*.cs` 但不是 `*.Designer.cs`：WinForms 主代码文件
- `*.Designer.cs`：WinForms 设计器文件
- `*.xaml`：WPF XAML 文件
- `*.xaml.cs`：WPF 代码隐藏文件
- `*.trans.log.md`：转换日志文件
- `*.review.log.md`：审查日志文件

---

## 开始执行

### 交互式参数输入（仅在参数为空时执行）

**检查参数状态**：
- 如果 {FILES}、{OUTPUT_DIR}、{LOG_FILE} 都已提供，跳过此步骤，直接进入"步骤 1"
- 如果任何一个参数为空，则执行以下交互式输入流程

**交互式输入流程**：

1. **输入文件列表**：
   - 请提供需要修复的文件列表（绝对路径，多个文件用逗号分隔）
   - 文件类型包括：
     - WinForms 原始文件（.cs 和 .Designer.cs）
     - WPF 转换结果文件（.xaml 和 .xaml.cs）
     - Transcode 日志文件（.trans.log.md）
     - Review 日志文件（.review.log.md）
   - 示例：`C:\Project\winform\Form1.cs,C:\Project\winform\Form1.Designer.cs,C:\Project\wpf\Form1.xaml,C:\Project\wpf\Form1.xaml.cs,C:\Project\wpf\Form1.trans.log.md,C:\Project\wpf\Form1.review.log.md`

2. **输入输出目录**：
   - 请提供输出目录的绝对路径
   - 修复后的文件将保存在此目录中
   - 示例：`C:\Project\wpf_fixed`

3. **输入日志文件名**：
   - 请提供日志文件的名称（不需要包含路径）
   - 示例：`Form1.fix.log.md`

**参数验证**：
- 确保所有文件路径都存在
- 确保输出目录可写
- 确保文件列表包含所有必需的文件类型

---

### 正式执行步骤

请按照以下步骤依次执行，完成代码修复：

### 步骤 1：文件分类和加载

1. **识别文件类型**：根据文件扩展名将传入的文件列表分类
2. **读取所有文件内容**：读取所有文件的内容，保存到内存中
3. **验证文件完整性**：确保每个文件组都包含必要的文件

### 步骤 2：分析日志

1. **读取 transcode 日志**：分析转换过程中记录的问题和注意事项
2. **读取 review 日志**：分析审查报告中记录的问题（错改、漏改、多改、需确认）
3. **汇总问题列表**：将两个日志中的问题合并，按优先级排序

### 步骤 3：加载规则

1. **加载规则索引**：读取 `prompt/rules/rule_index.md`
2. **加载相关规则**：根据问题类型，加载相关的转换规则文件

### 步骤 4：修复代码

1. **修复 XAML 文件**：
   - 根据 review 日志中的问题，修复 XAML 文件
   - 根据转换规则，确保 XAML 代码符合规范
2. **修复代码隐藏文件**：
   - 根据 review 日志中的问题，修复 .xaml.cs 文件
   - 根据 transcode 日志中的注意事项，确保代码逻辑正确
   - 根据转换规则，确保代码符合规范
3. **验证修复结果**：
   - 确保所有 review 日志中的问题都已修复
   - 确保代码逻辑与原始 WinForms 代码一致

### 步骤 5：生成输出

1. **创建输出目录**：确保 {OUTPUT_DIR} 目录存在
2. **写入修复后的文件**：
   - 将修复后的 .xaml 文件写入 {OUTPUT_DIR} 目录
   - 将修复后的 .xaml.cs 文件写入 {OUTPUT_DIR} 目录
3. **生成日志文件**：在 {OUTPUT_DIR} 目录中创建 {LOG_FILE}，记录修复过程和结果

### 步骤 6：日志记录

在 {LOG_FILE} 中记录以下内容：

```markdown
# 代码修复日志

## 文件信息

- WinForms 原始文件：[文件名]
- WPF 转换结果：[文件名]
- Transcode 日志：[文件名]
- Review 日志：[文件名]

## 问题汇总

### Transcode 日志中发现的问题

[列出 transcode 日志中的问题]

### Review 日志中发现的问题

[列出 review 日志中的问题]

## 修复记录

### XAML 文件修复

[记录 XAML 文件的修复内容]

### 代码隐藏文件修复

[记录 .xaml.cs 文件的修复内容]

## 修复结果

- 修复的问题数量：[数量]
- 输出文件：[文件列表]
```

---

## 注意事项

1. **必须读取所有文件**：确保读取所有传入的文件，不要遗漏
2. **严格基于日志修复**：不要随意修改代码，只修复日志中记录的问题
3. **保持代码一致性**：修复后的代码必须与原始 WinForms 代码逻辑一致
4. **遵循转换规则**：所有修复都必须遵循转换规则
5. **生成完整日志**：确保日志文件包含所有修复信息