# 步骤 2：后台代码审查

## 任务目标

根据后台代码转换规则检查后台代码转换的正确性。

## 执行操作

### 1. 加载审查规则

按照 `prompt/rules/rule_index.md` 中的规则加载流程，加载后台代码审查规则：
- 读取 `prompt/rules/rule_index.md`
- 根据文件内容识别需要加载的规则文件
- 加载规则文件

### 2. 执行审查

对每对后台代码文件进行审查：
- 读取 WinForms `.cs` 文件
- 读取 WPF `.xaml.cs` 文件
- 按加载的规则逐一检查
- 记录发现的问题

## 重要说明

**忽略被注释的代码**：
- 在审查过程中，遇到被注释的代码（以 `//` 或 `/* */` 包裹的代码），直接忽略，不需要提醒删除
- 不需要报告"注释的代码需要删除"这类问题
- 只关注实际生效的代码转换是否正确

## 检查项目

### 必须检查的项目
1. **命名空间替换**：`xIR.UI` → `XUI`
2. **控件引用**：控件名是否正确引用 XAML 中的控件
3. **属性访问**：属性访问方式是否正确转换
4. **事件处理**：事件挂载方式是否正确转换
5. **方法签名**：所有方法名、参数名是否保持一致
6. **变量命名**：所有变量名是否保持一致
7. **代码逻辑**：代码逻辑是否完全一致

## 问题分类

- **错改**：应该改但改错了的地方
- **漏改**：应该改但没改的地方
- **多改**：不应该改但改了的地方
- **需确认**：不确定是否正确，需要人工确认的地方

## 日志记录

将以下信息追加到临时报告文件 `{OUTPUT_DIR}/{REPORT_FILE}.tmp`：

```markdown
## 步骤2：后台代码审查

### 审查的文件对
- [WinForms.cs] ↔ [WPF.xaml.cs]
- [WinForms.cs] ↔ [WPF.xaml.cs]

### 详细审查结果

#### 文件对：[WinForms.cs] ↔ [WPF.xaml.cs]

##### 错改问题
- [规则名称] [代码位置]：[问题描述]
- [规则名称] [代码位置]：[问题描述]

##### 漏改问题
- [规则名称] [代码位置]：[问题描述]
- [规则名称] [代码位置]：[问题描述]

##### 多改问题
- [规则名称] [代码位置]：[问题描述]
- [规则名称] [代码位置]：[问题描述]

##### 需确认问题
- [规则名称] [代码位置]：[问题描述]
- [规则名称] [代码位置]：[问题描述]

##### 正确的转换
- [代码位置]：[转换说明]
- [代码位置]：[转换说明]

（继续记录其他文件对...）

### 审查统计
- 错改问题：X 个
- 漏改问题：X 个
- 多改问题：X 个
- 需确认问题：X 个
```

## 下一步

继续执行：[步骤 3：设计器代码审查](./step_03_designer_review.md)

---

## 错误处理

### 常见错误及处理方式

**错误 1：规则加载失败**
- 症状：无法加载规则文件
- 处理：检查规则文件路径是否正确，使用默认规则
- 日志记录：在日志中记录缺失的规则文件

**错误 2：文件读取失败**
- 症状：无法读取文件内容
- 处理：检查文件路径是否正确，文件是否存在
- 日志记录：在日志中记录文件路径和错误信息

**错误 3：审查失败**
- 症状：无法正确执行审查
- 处理：记录问题，继续审查其他文件
- 日志记录：在日志中记录审查失败的文件和原因

### 错误恢复策略
- 如果规则加载失败，使用内置的默认规则继续审查
- 如果文件读取失败，跳过该文件，继续审查其他文件
- 如果审查失败，记录问题，继续审查其他文件

### 错误日志格式
```
[ERROR] [步骤2] 规则加载失败: [规则文件路径]
[ERROR] [步骤2] 文件读取失败: [文件路径]
[ERROR] [步骤2] 审查失败: [文件名] - [原因]
```